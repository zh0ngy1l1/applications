<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Protected PDF</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    canvas { display: block; margin: 1em auto; }
  </style>
</head>
<body>

<input type="password" id="pw" placeholder="Password">
<button onclick="openPDF()">Open</button>

<div id="viewer"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

async function openPDF() {
  const password = document.getElementById("pw").value;

  const resp = await fetch("main.pdf.enc");
  const buf = new Uint8Array(await resp.arrayBuffer());

  // --- Parse layout ---
  const salt = buf.slice(0, 16);
  const iv   = buf.slice(16, 28);
  const tag  = buf.slice(28, 44);
  const data = buf.slice(44);

  // --- Derive key ---
  const baseKey = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(password),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: 100000,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["decrypt"]
  );

  // AES-GCM expects ciphertext || tag
  const combined = new Uint8Array(data.length + tag.length);
  combined.set(data);
  combined.set(tag, data.length);

  let plaintext;
  try {
    plaintext = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv: iv },
      key,
      combined
    );
  } catch {
    alert("Wrong password");
    return;
  }

  // --- Load PDF ---
  const pdfData = new Uint8Array(plaintext);
  const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

  const viewer = document.getElementById("viewer");
  viewer.innerHTML = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1.3 });

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    viewer.appendChild(canvas);

    await page.render({ canvasContext: ctx, viewport }).promise;
  }
}
</script>

</body>
</html>